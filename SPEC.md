# lal spec
`lal` is a simple command line tool that works on folders with a valid `manifest.json`, and accepts the following commands:

- [`lal install`](#lal-install-components) - install dependencies from `manifest.json` into `INPUT`
- [`lal status`](#lal-status) - print current installed dependencies with origin
- [`lal build [name]`](#lal-build-name-flags) - run canonical build in docker with current directory mounted
- [`lal shell`](#lal-shell) - enter container environment mounting current directory
- [`lal store name`](#lal-store-name) - copies current `OUTPUT` to cache
- `lal update-manifest`
- [`lal verify`](#lal-verify) - verify manifest validity + verify flat lockfile dependency tree

## Manifest
A per-repo file. Format looks like this (here annotated with illegal comments):

```json
{
  "name": "libwebsockets",  // name of repo
  "components": {           // map of components and default configuration
    "libwebsockets": "",
    "websockets_tests": "coverage"
  },
  "flags": [                // alternate configurations that build understands
    "clang",
    "asan",
    "tsan",
    "afl",
    "coverage"
  ],
  "dependencies": {
    "ciscossl": 42
  },
  "devDependencies": {
    "gtest": 42
  },
  "optionalDependencies": {
    "afl": {
      "afl-compiler": 20
    }
  }
}
```

## Lockfile
A per-build file auto-generated by `lal build` and will reduce the lockfiles generated from dependencies to provide aggregated information.

```json
{
  "name": "monolith",
  "date": "datestring",
  "commit": "sha",
  "version": "42000", // from --with-version or "experimental"
  "container": {
    "name": "edonusdevelopers/centos_build",
    "version": "sha"
  },
  "flags": "",
  "dependencies": {
    "ciscossl": {
      "version": "6",
    },
    "libwebsockets": {
      "version": "5",
      "dependencies": {
        "ciscossl": {
          "version": "6",
        }
      }
    }
  },
  "dev": {
    "gtest": {
      "version": "42"
    }
  }
}
```

## .lalrc
A per-machine configuration file from `lal configure`.

```json
{
  "container": "edonusdevelopers/centos_build",
  "cache": "~/.lal/cache",
  "registry": "http://engci-maven.cisco.com/artifactory/CME-group"
}
```

A specialized per-repo configuration file (`$PWD/.lalrc`) with the same format can override specific keys from the machine configuration.

## Caching
The local cache is populated when doing installs from the registry, when building locally, storing them, or when linking them directly.

```sh
~/.lal/cache $ tree .
.
├── globals
│   └── ciscossl
│       └── 6
│           ├── ciscossl.tar.gz
│           └── lockfile.json
└── store
    └── ciscossl
        └── asan
            ├── ciscossl.tar.gz
            └── lockfile.json
```

Sources:

- `globals` are unpacked straight from the registry
- `store` are tarballs of OUTPUT of builds when doing `lal store <name>`


### Common Command Specification
#### lal status
Provides list of dependencies currently installed.
If they are not in the manifest they will be listed as _extraneous_.
If they are modified (not a global fetch) they will be listed as _modified_.

#### lal build [name] [flags]
Runs the `BUILD` script in the current directory in the container.

If no arguments are suppplied it will run `./BUILD $name` where `name` is the value of `name` in the manifest.

E.g. `lal build` in monolith will `./BUILD dme` in the container.

`lal build` will run `lal verify` and warn if this fails, but proceed anyway. The warning is a developer notice that the build will not be identical on jenkins due to local modifications and should not be ignored indefinitely.

Release specific flags:

- *--release*: Generate a tarball and lockfile in `./ARTIFACT` folder after building
- *--with-version n*: Jenkins specific option which will specify lockfile version

If `--with-version` is passed, `lal verify` must pass for build to pass.

Passing configuration flags:

- *--use flagname*: Pass a named flag to `BUILD` to use this configuration.

This allows multiple invocations, i.e. `lal build --use asan --use clang` is valid, provided the manifest specifies both "asan" and "clang" in its `flags` array.

#### lal install [components..]
Comes in two variants.

 - *lal install [--dev]*: fetches versions corresponding to the manifest from the registry and puts them into `INPUT`. The optional `--dev` flag will also cause `devDependencies` to be installed.

 - *lal install component=version [--save]*: fetches a specific version. The optional `--save` flag will also update the manifest file locally.

The specific version is either a number corresponding to the last tag, or it's a name corresponding to something in `store` (see `lal store`). Without a specific version, the latest version is installed.

### Uncommon/Advanced/Internal Command Specification
#### lal shell
Enters an interactive shell in the container listed in `.lalrc` mounting the current directory.

Useful for experimental builds with stuff like `bcm` and `opts`.
Assumes you have run `lal install` or equivalent so that `INPUT` is ready for this.

Should run:

```sh
docker run \
  -v $HOME/.gitconfig:/home/lal/.gitconfig \
  -v $PWD:/home/lal/volume \
  -w /home/lal/volume \
  --net host \
  --cap-add SYS_NICE \
  --user lal \
  -it $LALCONTAINER \
  /bin/bash
```

You may just have your own wrapper for this anyway, but this is the canonical one. You can not use `lal` inside the container anyway.

#### lal store <name>
Stashes the current `OUTPUT` folder to in `~/.lal/cache/store/${component}/${NAME}` for future reuse. This can be installed into another repository with `lal install component=name`

#### lal verify
Verifies that:

- `manifest.json` exists in `$PWD` and is valid JSON
- dependencies in `INPUT` match `manifest.json`.
- the dependency tree is flat.
- `INPUT` contains only global dependencies.

#### lal configure
Interactively configures:

- docker container to use for `build` (default: edonusdevelopers/centos_build)
- registry to use (default: http://engci-maven.cisco.com/artifactory/CME-group)
- cache directory to use (default: ~/.lal/cache)
- cache size warning (default: 5G)

To get defaults use `lal configure -y`.

### Universal Options

- `--help` or `-h`
